image: docker:latest

stages:
  - build
  - test
  - tag

variables:
  DOCKER_IMAGE_ADDONS: plaza-core-addons
  DOCKER_IMAGE_FRONTEND: plaza-core-frontend
  DOCKER_IMAGE_BACKEND: plaza-core-backend
  DOCKER_IMAGE_BACKEND_TEST: plaza-core-backend-test
  DOCKER_BACKEND_CI_BASE: plazaproject/ci-base-backend:52db1adcf019a16a12fd9fe4d6c1c2534d68b561

services:
  - docker:dind

## Frontend
# Non-pushing
nopush-build-frontend:
  stage: build
  before_script:
    - cd frontend
  script:
    - docker build -t "$DOCKER_IMAGE_FRONTEND" -f scripts/ci-partial.dockerfile .
  except:
    - develop
    - master
    - push-docker-images-on-ci # TODO: Remove

# Pushing
build-frontend:
  stage: build
  before_script:
    - cd frontend
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t "$CI_REGISTRY"/plaza-project/plaza-core/frontend:$CI_COMMIT_SHA -f scripts/ci-partial.dockerfile .
    - docker push "$CI_REGISTRY"/plaza-project/plaza-core/frontend:$CI_COMMIT_SHA
  only:
    - develop
    - master
    - push-docker-images-on-ci # TODO: Remove

tag-frontend:
  stage: tag
  dependencies:
    - build-frontend
  before_script:
    - cd frontend
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull "$CI_REGISTRY"/plaza-project/plaza-core/frontend:$CI_COMMIT_SHA
    - docker tag "$CI_REGISTRY"/plaza-project/plaza-core/frontend:$CI_COMMIT_SHA "$CI_REGISTRY"/plaza-project/plaza-core/frontend:$CI_COMMIT_REF_NAME
    - docker push "$CI_REGISTRY"/plaza-project/plaza-core/frontend:$CI_COMMIT_REF_NAME
  only:
    - develop
    - master
    - push-docker-images-on-ci # TODO: Remove

## Backend
# Non-pushing
nopush-build-backend:
  stage: build
  before_script:
    - cd backend
  script:
    - docker build -t "$DOCKER_IMAGE_BACKEND" -f scripts/ci-partial.dockerfile .
  except:
    - master
    - develop
    - push-docker-images-on-ci # TODO: Remove

nopush-test-backend:
  stage: test
  dependencies:
    - nopush-build-backend
  before_script:
    - cd backend
  script:
    - docker build -t "$DOCKER_IMAGE_BACKEND_TEST" -f scripts/ci-partial.dockerfile .
    - docker run -t --rm "$DOCKER_IMAGE_BACKEND_TEST" rebar3 eunit
  except:
    - master
    - develop
    - push-docker-images-on-ci # TODO: Remove

nopush-dialyze-backend:
  stage: test
  dependencies:
    - nopush-build-backend
  before_script:
    - cd backend
  script:
    - docker build -t "$DOCKER_IMAGE_BACKEND_TEST" -f scripts/ci-partial.dockerfile .
    - docker build --cache-from "$DOCKER_BACKEND_CI_BASE" -t "$DOCKER_IMAGE_BACKEND_TEST" -f scripts/ci-partial.dockerfile .
    - docker run -t --rm "$DOCKER_IMAGE_BACKEND_TEST" rebar3 dialyzer
  except:
    - master
    - develop
    - push-docker-images-on-ci # TODO: Remove

# Pushing
build-backend:
  stage: build
  before_script:
    - cd backend
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_SHA -f scripts/ci-partial.dockerfile .
    - docker push "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_SHA
  only:
    - develop
    - master
    - push-docker-images-on-ci # TODO: Remove

test-backend:
  stage: test
  dependencies:
    - build-backend
  before_script:
    - cd backend
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker run -t --rm "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_SHA rebar3 eunit
  only:
    - master
    - develop
    - push-docker-images-on-ci # TODO: Remove

dialyze-backend:
  stage: test
  dependencies:
    - build-backend
  before_script:
    - cd backend
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker run -t --rm "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_SHA rebar3 dialyzer
  only:
    - master
    - develop
    - push-docker-images-on-ci # TODO: Remove

tag-backend:
  stage: tag
  dependencies:
    - test-backend
    - test-backend
    - dialyze-backend
  before_script:
    - cd backend
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_SHA
    - docker tag "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_SHA "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_REF_NAME
    - docker push "$CI_REGISTRY"/plaza-project/plaza-core/backend:$CI_COMMIT_REF_NAME
  only:
    - develop
    - master
    - push-docker-images-on-ci # TODO: Remove
